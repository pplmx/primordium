# 修订历史 - Primordium (原初之境)

[English](../CHANGELOG.md)

本文件记录了 **Primordium** 项目的所有重大变更。本项目遵循基于阶段的演进式开发周期。

---

## [阶段 13: 多人联机 (Multiplayer)] - 2026-01-21

### 进化跃迁：星际移民

Primordium 现在支持分布式模拟，实体可以通过中继服务器在不同用户的“宇宙”之间迁移。

#### ✨ 新特性

- **中继服务器**：基于 `axum` 和 WebSockets 的新 `primordium-server` 二进制文件，用于路由流量。
- **客户端网络**：WASM 客户端可连接中继服务器并发送/接收实体。
- **跨界迁移**：触碰世界边缘的实体会被序列化并发送给其他已连接的客户端。
- **实时可视化**：Web UI 显示连接状态和网络事件。

#### 🛠️ 技术成就

- **WebSocket 协议**：用于握手和实体传输的自定义 JSON 协议。
- **多箱 (Multi-Crate) 工作区**：项目结构更新以支持 `bin` (服务器) 和 `lib/wasm` (客户端) 目标。
- **实体序列化**：DNA 和统计数据在网络传输期间得以保留。

---

## [阶段 14: 游戏性与打磨 (Gameplay & Polish)] - 2026-01-21

### 演进飞跃：分歧的现实与数字稳定性

模拟现在支持不同的游戏模式，并经过大规模架构重构和全方位质量门禁，达到了巅峰稳定性。

#### ✨ 新特性

- **游戏模式**：
  - **合作模式 (`--gamemode coop`)**：强制全球和平；适合聚落生长。
  - **大逃杀模式 (`--gamemode battle`)**：收缩的世界边界迫使冲突发生。
- **增强型 TUI**:
  - **图例栏 (Legend Bar)**: 新增第四行状态栏，实时对照实体状态与地形符号。
  - **帮助系统**: 新增四页式标签化帮助菜单（控制、符号、概念、纪元）。
  - **新手引导**: 为初次进入模拟的“神明”提供 3 页式基础教程。
- **文档**：
  - 全面的 **用户手册** (双语)。
  - **技术维基** 涵盖遗传学、大脑和生态系统。
  - **智能体记忆**: 新增 `AGENTS.md` 辅助 AI 协作开发。

#### 🛠️ 技术成就

- **模块化重构**: 将 870 行的单体文件 `app.rs` 彻底拆分为 `src/app/` 下的清晰模块结构。
- **质量门禁**: 建立了基于 Husky 的严格提交前流水线（格式化、类型检查、Clippy、全量测试）。
- **全面测试**: 新增 30+ 测试用例，覆盖核心逻辑（大脑、实体、空间索引）及集成流（生命周期、DNA 协议、纪元切换）。
- **性能优化**:
  - 为发布版本启用了 **LTO** (链接时优化)。
  - 使用优化后的迭代器和空间哈希取代了 $O(N^2)$ 性能瓶颈。
- **鲁棒性**: 实现 100% Clippy 规范化，并自动管理日志目录生命周期。

---

## [阶段 15-17: 生物与生态深度] - 2026-01-21

### 演进飞跃：生命周期、营养级与土地健康

数字生态系统已进化为一个复杂的生命网，包含发育阶段、食性分化以及环境反馈循环。

#### ✨ 功能特性

- **阶段 15: 生命周期 (Life Cycles)**：
  - **幼体状态 (◦)**：实体现在以未成熟状态出生，必须存活 150 刻才能成年。
  - **发育门禁**：幼体无法繁殖，创造了一个脆弱的生命初期阶段。
- **阶段 16: 营养级 (Trophic Levels)**：
  - **食草动物 (H-)**：专注于植物采集；捕食效率极低（0.2x 能量收益）。
  - **食肉动物 (C-)**：专性掠食者；无法食用植物，但捕食效率极高（1.2x 能量收益）。
  - **物种形成 (Speciation)**：基因组在繁殖过程中可以通过特定的变迁率切换营养角色。
- **阶段 17: 生态演替 (Ecological Succession)**：
  - **地形健康 (肥力)**：土地现在拥有肥力等级，采食植物会消耗局部肥力。
  - **荒芜地形 (░)**：过度采食的土地会变得荒芜，停止食物生成并减缓移动速度，直到恢复。
  - **自然恢复**：土壤肥力随时间缓慢再生，迫使种群发生迁徙。

#### 🛠️ 技术成就

- **增强型大脑**: 扩展神经网络 (6-6-5) 以处理社会和环境信号。
- **生态逻辑**: 将肥力消耗整合进世界更新循环。
- **视觉反馈**: 为幼体和荒芜地形新增 TUI 符号与颜色。
- **验证**: 新增 `tests/ecology.rs` 覆盖肥力循环与营养限制。

---

## [阶段 12: WebAssembly 移植 (WebAssembly Port)] - 2026-01-21

### 进化跃迁：打破终端壁垒

Primordium 现在可以通过 WebAssembly 和 HTML5 Canvas 在现代网络浏览器中运行。

#### ✨ 新特性

- **WASM 支持**：核心模拟通过 `wasm-pack` 编译为 WebAssembly。
- **Canvas 渲染**：新增 `WebRenderer` 替代 TUI，实现 60 FPS 浏览器可视化。
- **Web 界面**：具有实时统计和控制功能的现代“玻璃拟态 (Glassmorphism)” UI。
- **双目标支持**：项目同时支持原生 CLI (TUI) 和 Web (Canvas) 构建。

#### 🛠️ 技术成就

- **库重构**：将核心逻辑提取到 `lib.rs` 以支持双目标。
- **条件编译**：使用 `#[cfg(target_arch = "wasm32")]` 保持原生兼容性。
- **JS 互操作**：通过 `wasm-bindgen` 将 `Simulation` 结构体和 `draw` 方法暴露给 JavaScript。

---

## [阶段 11: 社会结构 (Social Structures)] - 2026-01-21

### 进化跃迁：信息素、部落与合作

本阶段通过化学通信、亲缘识别和合作行为引入涌现社会行为。

#### ✨ 新特性

- **信息素系统**：实体留下持久化学踪迹：
  - **食物信息素**：进食时沉积，吸引觅食者
  - **危险信息素**：杀戮地点沉积，警告掠食者存在
  - 信息素随时间衰减（每tick衰减0.5%）
- **部落形成**：基于颜色的亲缘识别：
  - 颜色相近的实体（RGB距离<60）形成部落
  - 同部落成员永不互相攻击
- **领地行为**：实体在出生地附近攻击性提高50%
- **能量分享**：高能量实体可与饥饿邻居分享能量
  - 新增"分享"状态（♣）表示主动分享
- **扩展神经网络**：6输入 → 6隐藏 → 5输出：
  - 新增输入：信息素强度、部落密度
  - 新增输出：分享意图

#### 🛠️ 技术成就

- **信息素网格**：高效网格化信息素存储与衰减
- **Vec神经网络**：数组转Vec以支持serde序列化
- **社交符号**：新增分享符号（♣）和绿色状态颜色

---

## [阶段 10: 生态动力学 (Ecosystem Dynamics)] - 2026-01-21

### 演进飞跃：地形、地理与季节

此阶段通过地形系统和季节循环引入环境异质性，实现涌现式迁徙模式。

#### ✨ 功能特性

- **地形系统**：程序化生成的世界地形，包含独特生态区：
  - **山脉** (▲)：移动速度降低 50%，无食物生成
  - **河流** (≈)：移动速度提升 50%
  - **绿洲** (◊)：食物生成率 ×3，吸引迁徙
- **季节循环**：动态四季系统，影响生态平衡：
  - **春天**：食物 ×1.5，代谢 ×0.8（生长期）
  - **夏天**：食物 ×1.0，代谢 ×1.2（活跃期）
  - **秋天**：食物 ×1.2，代谢 ×1.0（收获期）
  - **冬天**：食物 ×0.5，代谢 ×1.5（生存期）
- **地形感知 AI**：实体根据脚下地形自动调整移动速度
- **地理食物分布**：食物自然聚集在绿洲周围

#### 🛠️ 技术成就

- **噪声生成**：多八度值噪声实现自然地形分布
- **分层渲染**：地形作为背景层绘制在实体之前

---

## [阶段 9: 全知之眼 (The Omniscient Eye)] - 2026-01-21

### 演进飞跃：深度分析与可视化叙事

此阶段引入全面的世界分析系统和叙事机制，让模拟世界栩栩如生。

#### ✨ 功能特性

- **纪元系统 (Era System)**：集成了由种群规模驱动的状态机，叙述世界演进纪元（创世、扩张、黄金时代、衰落等）。
- **名人堂 (Hall of Fame)**：实时排行榜，追踪模拟中适应度最高的前 3 名生物。
- **可视化叙事**：状态感知符号（†♥♦●）和基于生理状态的动态颜色映射。
- **高级分析**：滚动脑熵（香农熵）和平均寿命指标，用于监控生物多样性。
- **种群动态**：双火花线系统，实时可视化种群健康状况与硬件压力对比。

---

## [阶段 8: 顶级掠食者与基因协同 (Apex Predators & Genetic Synergy)] - 2026-01-20

### 演进飞跃：捕食、有性繁殖与数据可移植性

此阶段通过引入捕食者-猎物动态和基因交换机制，提升了模拟的复杂性。

#### ✨ 功能特性

- **进化捕食**：新增第 4 个神经输出"攻击性"，使生物能够捕食其他生物并获得巨大能量收益（80% 转化率）。
- **有性繁殖**：实现基因交叉，允许生物与附近配偶结合神经特征。
- **HexDNA 协议**：稳健的序列化格式，支持通过文本文件导出（`C` 键）和注入（`V` 键）生物。
- **高级感知**：重构感知系统，在多轮世界更新中避免借用检查器冲突。
- **增强编年史**：UI 事件日志现可叙述捕食事件和基因风暴。

---

## [阶段 7: 神圣交互 (Divine Interface)] - 2026-01-20

### 演进飞跃：交互与分类学

此阶段的重点是从被动观察者转变为主动的“数字神明”，引入了干预工具和复杂的物种分类系统。

#### ✨ 功能特性

- **鼠标驱动交互**：启用了完整的终端鼠标支持。用户现在可以点击单个生物来检查其神经状态、血统和特定的遗传特征。
- **程序化命名 engine**：每个生物现在都会根据其基因型分配一个唯一的、程序化生成的名称（例如 *Xylos-Tetra*, *Aether-7*），不再使用原始 UUID，以增强叙事感。
- **实时 UI 编年史**：实现了实时事件日志（“编年史”），叙述重大的演进事件（例如“第 5000 刻的大饥荒”，“传奇英雄 *Zenith* 已陨落”）。
- **神圣干预工具**：
  - **基因浪潮 (Genetic Surge)**：手动触发高变异爆发，强制种群快速适应。
  - **资源投放 (Food Injection)**：交互式放置资源簇，引导种群迁移。
- **基于基因型的物种聚类**：实现了 L2 范数距离算法，根据神经权重相似性将生物分组为“物种”，允许 UI 实时监控生物多样性及不同谱系的兴衰。

#### 🛠️ 技术成就

- **事件驱动的 UI 更新**：优化了事件循环，每帧排空事件队列，确保鼠标交互零延迟。
- **空间哈希查询**：集成了基于网格的空间分区系统，支持实时鼠标拾取并将感官查询复杂度优化至 $O(N \log N)$。

---

## [阶段 6: 沉浸 (Immersion)] - 2026-01-15

### 优化与部署阶段

专注于性能、灵活性和“屏幕保护程序”式的体验。

#### ✨ 功能特性

- **空间哈希优化 (Spatial Hash)**：使用动态空间哈希网格取代了 $O(N^2)$ 的邻居检查，支持在标准硬件上流畅运行 500+ 实体。
- **多模式支持**：
  - **标准模式**：具有完整仪表板的 TUI 界面。
  - **画境模式 (Screensaver)**：极简、无干扰的世界视图。
  - **静默模式 (Headless)**：用于数据挖掘和长期演进研究的高速后台模拟。
- **配置系统**：将所有模拟常量外部化到 `config.toml`，支持热调参。

---

## [阶段 5 & 5.5: 账本与区块链 (The Ledger & Blockchain)]

### 永恒历史与独立分析

确保每一个传奇的生命都被刻在数字穹顶之上。

#### ✨ 功能特性

- **JSONL 事件日志**：将每一次出生、死亡和环境变迁稳健地流式传输到 `logs/live.jsonl`。
- **传奇判定标准**：自动归档满足精英适应度阈值的“传奇生物”。
- **OpenTimestamps 锚定**：会话日志的 SHA-256 哈希被锚定到比特币区块链。
- **独立工具集**：
  - `primordium-ledger-analyzer`：生成详细报告及家谱可视化。
  - `primordium-ledger-verifier`：验证本地日志的完整性。

---

## [阶段 4: 神经觉醒 (Neural Awakening)]

### 向智能的过渡

用感官驱动的神经处理取代随机运动。

#### ✨ 功能特性

- **4x6x3 神经网络**：为每个生物实现多层感知器 (MLP)。
- **感官输入**：食物向量、能量储备、局部拥挤度。
- **实时大脑热图**：实时可视化当前选中生物的突触权重。

---

## [阶段 1-3: 原初与共振 (Genesis & Resonance)]

### 基础与硬件耦合

宇宙的诞生以及代码与硅片的耦合。

#### ✨ 功能特性

- **Ratatui 基础**：建立了高性能的 TUI 框架。
- **代谢能量循环**：复杂的生存系统，动作即能量。
- **硬件耦合气候**：将 CPU/RAM 负载转化为环境压力。
