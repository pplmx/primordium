# 修订历史 - Primordium (原初之境)

[English](../CHANGELOG.md)

本文件记录了 **Primordium** 项目的所有重大变更。本项目遵循基于阶段的演进式开发周期。

---

## [阶段 24: 谱系与宏观演化 (Lineage & Macroevolution)] - 2026-01-23

### 演进飞跃：祖先追踪与王朝霸权

阶段 24 将关注点从个体生存转向祖先谱系的长期成功。通过引入正式的谱系追踪，模拟现在可以可视化特定“王朝”在数代之间、甚至在不同模拟宇宙之间的兴衰。

#### ✨ 功能特性

- **谱系追踪 (Lineage Tracking)**: 每个生物现在都被分配了一个永久的 `lineage_id`，从其祖先处继承。
- **王朝统治可视化**: TUI 现在可以显示最成功的谱系，展示哪些祖先品系目前正统治着生态系统。
- **跨宇宙祖先保存**: 在跨宇宙迁移过程中保留谱系数据，让您的“优势族群”即使在异域模拟中也能保持其身份。
- **宏观演化统计**: 新增对谱系多样性、特定品系灭绝率和祖先长寿度的统计追踪。

---

## [阶段 23: 表型特化 (Phenotypic Specialization)] - 2026-01-23

### 演进飞跃：物理多样性与生存权衡

生物不再是物理上完全相同的个体。演化现在同时作用于物理特征（表型）和神经智能，创造了一个更多元化、更具专业性的生态系统。

#### ✨ 功能特性

- **统一基因型 (Unified Genotype)**: 将物理特征直接整合到基因序列中。所有属性现在都是可变、可遗传的，并受自然选择影响。
- **可变感知半径**: 生物可以进化出 3.0 到 15.0 单位之间的感知半径。
- **可变最大速度**: 移动能力范围扩展至每 tick 0.5 到 3.0 单位。
- **可变能量上限**: 能量存储容量（胃部大小）现在是一个可进化特征 (100-500)。

#### 🛠️ 技术成就

- **表型权衡引擎**: 实现了动态代谢缩放。优越的特征现在伴随着沉重的代价：
    - 感知：+0.1 半径 -> +2% 静息消耗。
    - 速度：+0.1 速度 -> +5% 移动消耗。
- **生物力学惯性**: 引入了质量-响应模型，更高的能量容量会降低加速度（转向响应性）。
- **遗传同步优化**: 优化了繁殖系统，确保表型基因在基因型 (Genotype) 与组件 (Component) 状态之间正确同步。

---

## [阶段 22: 并行演化与全球蜂巢 (Parallel Evolution & Global Hive)] - 2026-01-23

### 演进飞跃：分布式智能与多重宇宙

模拟已经超越了单机限制，允许生物在全球网络中迁移，并在共享的数字“蜂巢”中共同演化。

#### ✨ 功能特性

- **全球蜂巢迁移**: 触碰世界边界的实体现在可以被序列化，并通过中央中继站传输到其他连接的模拟实例。
- **中继服务器架构**: 基于 **Axum** 构建的新型高性能中继服务器，用于管理跨多重宇宙的生命分配。
- **RESTful 监控**: 实时 API 接口，用于检查全球模拟健康状况、对等节点数和迁移流量。
- **P2P 发现机制**: 在全球蜂巢内实现自动化的对等节点宣告与列表维护。

#### 🛠️ 技术成就

- **异步网络**: 实现了基于 WebSocket 的非阻塞协议，用于实时的实体传输。
- **安全锚定**: 将基于比特币的历史验证集成到网络堆栈中，确保迁入生物的真实性。
- **增强型网络测试**: 覆盖了实体序列化、WebSocket 握手和广播逻辑的全面集成测试。

---

## [阶段 21: 环境流动性与灾难 (Environmental Fluidity & Disasters)] - 2026-01-21

### 演进飞跃：时间连贯性与动态危机

数字生态系统获得了“记忆”并面临首次环境大灾难，这要求生物进化出更复杂的生存策略。

#### ✨ 功能特性

- **循环神经网络 (RNN-lite)**: 升级了大脑架构，引入上一个 tick 隐藏层的反馈回路，实现了时间连贯的行为和内部记忆。
- **沙尘暴灾难 (Dust Bowl)**: 引入了动态地形事件。当种群压力过大且处于热浪时，会触发大规模土地肥力损耗和荒芜化。
- **物理障碍**: 增加了不可穿透的 `Wall` (墙壁/岩石) 地形，迫使生物进化出转向和避障能力。
- **局部感知**: 从全局食物知识迁移到真实的“感知半径”（20单位），由专门的 `food_hash` 提供动力。

#### 🛠️ 技术成就

- **O(1) 感知**: 集成了第二个空间哈希 (Spatial Hash) 专门用于资源管理，降低了感官查询复杂度。
- **缓冲池 (Buffer Pooling)**: 在 `World` 结构体中实现了可重用的堆分配，显著降低了并行执行时的内存分配开销。
- **有状态智能**: 在 `Intel` 组件中增加了持久化的 `last_hidden` 状态，支持新的循环大脑架构。
- **物理引擎升级**: 增强了 `handle_movement` 逻辑，支持对不可通行地形的碰撞检测与反弹。
- **自动化验证**: 新增 `tests/disasters.rs` 覆盖了灾难触发与物理碰撞逻辑。

---

## [阶段 20: 认知合成与系统重构 (Cognitive Synthesis & Systemic Refactor)] - 2026-01-21

### 演进飞跃：基于组件的生命与并行智能

模拟经历了自项目启动以来最重大的架构演进，转向了专为极致性能和超大规模扩展设计的模块化组件系统。

#### ✨ 功能特性

- **基于组件的实体 (CBE)**: 生物属性现已逻辑分组为物理 (Physics)、代谢 (Metabolism)、健康 (Health) 和智力 (Intel) 组件，提升了系统隔离度和数据局部性。
- **系统化解耦**: 世界更新循环被拆分为一系列专业化的“系统”（感知、行动、生物、社交），使逻辑更易于扩展和维护。
- **Rayon 驱动的并行化**: 集成了 Rayon 数据并行库，利用多核 CPU 处理沉重的计算任务。
- **高密度扩展**: 针对 5000+ 同时存在的实体进行了优化，支持多线程神经推理。

#### 🛠️ 技术成就

- **并行大脑推理**: 神经网络前向传播现已通过 `.par_iter()` 实现并行处理。
- **系统流水线**: 将 `World::update` 重构为离散阶段，解决了长期存在的“单体代码”技术债务。
- **数据局部性**: 组件分组使模拟每系统仅处理相关数据子集，减少了缓存失效。
- **逻辑等效性**: 在大幅提升吞吐量的同时，实现了与之前版本 100% 的功能等效。

---

## [阶段 19: 昼夜循环 (Circadian Rhythms)] - 2026-01-21

### 演进飞跃：时间维度的引入

数字生态系统现在随昼夜周期波动，影响植物生长及生物的新陈代谢。

#### ✨ 功能特性

- **昼夜周期**: 引入全球时钟（默认 2000 刻），实现白昼与黑夜的交替。
- **光照依赖生长**: 食物生成概率与当前光照强度 (`light_level`) 挂钩。正午生长最快，黑夜几乎停滞。
- **休息代谢**: 生物在夜间进入低功耗模式，静息能量消耗降低 40%。
- **TUI 可视化**: 状态栏实时显示昼夜图标 (☀️/🌙) 及当前时钟进度。

#### 🛠️ 技术成就

- **环境状态推进**: 在世界更新循环中集成了 `Environment::tick` 机制。
- **物理耦合**: 将光照强度和昼夜系数整合进核心代谢算法中。
- **验证**: 新增 `test_light_dependent_food_growth` 集成测试验证光照对生态的影响。

---

## [阶段 15-18: 生物学、生态与病原体] - 2026-01-21

### 演进飞跃：完善的生命链与免疫演化

数字生态系统已进化为一个具有深度防御与发育机制的复杂网络，引入了病原体威胁、生命周期管理及食性特化。

#### ✨ 功能特性

- **阶段 15: 生命周期 (Life Cycles)**：
    - **幼体状态 (◦)**：实体必须存活 150 刻才能成年。
    - **发育门禁**：幼体无法繁殖。
- **阶段 16: 营养级 (Trophic Levels)**：
    - **食性分化**：分为食草 (H-) 和食肉 (C-) 角色。
    - **收益博弈**：食肉动物捕食收益更高，但无法以植物为食。
- **阶段 17: 生态演替 (Ecological Succession)**：
    - **土地肥力**：采食会消耗地块肥力，低肥力地块变为“荒芜 (░)”。
    - **动态恢复**：肥力随时间再生，驱动种群迁徙。
- **阶段 18: 病原体与免疫 (Pathogens & Immunity)**：
    - **传染病模拟**：病原体可在实体间邻近传播。
    - **免疫进化**：实体在康复后提升免疫力，并将抗性遗传给下一代。
    - **环境爆发**：随机产生的环境病原体增加长期生存挑战。

#### 🛠️ 技术成就

- **系统重构**: 优化了 `World::update` 中的空间哈希处理逻辑，支持跨实体的复杂感知与传染判定。
- **分层验证**: 新增 `tests/ecology.rs` 和 `tests/pathogens.rs`，实现了 100% 的关键逻辑覆盖。
- **视觉反馈**: TUI 界面新增感染 (☣) 符号及动态颜色标识。

---

## [阶段 14: 游戏性与打磨 (Gameplay & Polish)] - 2026-01-21

### 演进飞跃：分歧的现实与数字稳定性

模拟现在支持不同的游戏模式，并经过大规模架构重构和全方位质量门禁，达到了巅峰稳定性。

#### ✨ 新特性

- **游戏模式**：
    - **合作模式 (`--gamemode coop`)**：强制全球和平；适合聚落生长。
    - **大逃杀模式 (`--gamemode battle`)**：收缩的世界边界迫使冲突发生。
- **增强型 TUI**:
    - **图例栏 (Legend Bar)**: 新增第四行状态栏，实时对照实体状态与地形符号。
    - **帮助系统**: 新增四页式标签化帮助菜单（控制、符号、概念、纪元）。
    - **新手引导**: 为初次进入模拟的“神明”提供 3 页式基础教程。
- **文档**：
    - 全面的 **用户手册** (双语)。
    - **技术维基** 涵盖遗传学、大脑和生态系统。
    - **智能体记忆**: 新增 `AGENTS.md` 辅助 AI 协作开发。

#### 🛠️ 技术成就

- **模块化重构**: 将 870 行的单体文件 `app.rs` 彻底拆分为 `src/app/` 下的清晰模块结构。
- **质量门禁**: 建立了基于 Husky 的严格提交前流水线（格式化、类型检查、Clippy、全量测试）。
- **全面测试**: 新增 30+ 测试用例，覆盖核心逻辑（大脑、实体、空间索引）及集成流（生命周期、DNA 协议、纪元切换）。
- **性能优化**:
    - 为发布版本启用了 **LTO** (链接时优化)。
    - 使用优化后的迭代器和空间哈希取代了 $O(N^2)$ 性能瓶颈。
- **鲁棒性**: 实现 100% Clippy规范化，并自动管理日志目录生命周期。

---

## [阶段 13: 多人联机 (Multiplayer)] - 2026-01-21

### 进化跃迁：星际移民

Primordium 现在支持分布式模拟，实体可以通过中继服务器在不同用户的“宇宙”之间迁移。

#### ✨ 新特性

- **中继服务器**：基于 `axum` 和 WebSockets 的新 `primordium-server` 二进制文件，用于路由流量。
- **客户端网络**：WASM 客户端可连接中继服务器并发送/接收实体。
- **跨界迁移**：触碰世界边缘的实体会被序列化并发送给其他已连接的客户端。
- **实时可视化**：Web UI 显示连接状态 and 网络事件。

#### 🛠️ 技术成就

- **WebSocket 协议**：用于握手和实体传输的自定义 JSON 协议。
- **多箱 (Multi-Crate) 工作区**：项目结构更新以支持 `bin` (服务器) 和 `lib/wasm` (客户端) 目标。
- **实体序列化**：DNA 和统计数据在网络传输期间得以保留。

---

## [阶段 12: WebAssembly 移植 (WebAssembly Port)] - 2026-01-21

### 进化跃迁：打破终端壁垒

Primordium 现在可以通过 WebAssembly 和 HTML5 Canvas 在现代网络浏览器中运行。

#### ✨ 新特性

- **WASM 支持**：核心模拟通过 `wasm-pack` 编译为 WebAssembly。
- **Canvas 渲染**：新增 `WebRenderer` 替代 TUI，实现 60 FPS 浏览器可视化。
- **Web 界面**：具有实时统计和控制功能的现代“玻璃拟态 (Glassmorphism)” UI。
- **双目标支持**：项目同时支持原生 CLI (TUI) 和 Web (Canvas) 构建。

#### 🛠️ 技术成就

- **库重构**：将核心逻辑提取到 `lib.rs` 以支持 dual 目标。
- **条件编译**：使用 `#[cfg(target_arch = "wasm32")]` 保持原生兼容性.
- **JS 互操作**：通过 `wasm-bindgen` 将 `Simulation` 结构体和 `draw` 方法暴露给 JavaScript。

---

## [阶段 11: 社会结构 (Social Structures)] - 2026-01-21

### 进化跃迁：信息素、部落与合作

本阶段通过化学通信、亲缘识别和合作行为引入涌现社会行为。

#### ✨ 新特性

- **信息素系统**：实体留下持久化学踪迹：
    - **食物信息素**：进食时沉积，吸引觅食者
    - **危险信息素**：杀戮地点沉积，警告掠食者存在
    - 信息素随时间衰减（每tick衰减0.5%）
- **部落形成**：基于颜色的亲缘识别：
    - 颜色相近的实体（RGB距离<60）形成部落
    - 同部落成员永不互相攻击
- **领地行为**：实体在出生地附近攻击性提高50%
- **能量分享**：高能量实体可与饥饿邻居分享能量
    - 新增"分享"状态（♣）表示主动分享
- **扩展神经网络**：6输入 → 6隐藏 → 5输出：
    - 新增输入：信息素强度、部落密度
    - 新增输出：分享意图

#### 🛠️ 技术成就

- **信息素网格**：高效网格化信息素存储与衰减
- **Vec神经网络**：数组转Vec以支持serde序列化
- **社交符号**：新增分享符号（♣）和绿色状态颜色

---

## [阶段 10: 生态动力学 (Ecosystem Dynamics)] - 2026-01-21

### 演进飞跃：地形、地理与季节

此阶段通过地形系统和季节循环引入环境异质性，实现涌现式迁徙模式。

#### ✨ 功能特性

- **地形系统**：程序化生成的世界地形，包含独特生态区：
    - **山脉** (▲)：移动速度降低 50%，无食物生成
    - **河流** (≈)：移动速度提升 50%
    - **绿洲** (◊)：食物生成率 ×3，吸引迁徙
- **季节循环**：动态四季系统，影响生态平衡：
    - **春天**：食物 ×1.5，代谢 ×0.8（生长期）
    - **夏天**：食物 ×1.0，代谢 ×1.2（活跃期）
    - **秋天**：食物 ×1.2，代谢 ×1.0（收获期）
    - **冬天**：食物 ×0.5，代谢 ×1.5（生存期）
- **地形感知 AI**：实体根据脚下地形自动调整移动速度
- **地理食物分布**：食物自然聚集在绿洲周围

#### 🛠️ 技术成就

- **噪声生成**：多八度值噪声实现自然地形分布
- **分层渲染**：地形作为背景层绘制在实体之前

---

## [阶段 9: 全知之眼 (The Omniscient Eye)] - 2026-01-21

### 演进飞跃：深度分析与可视化叙事

此阶段引入全面的世界分析系统和叙事机制，让模拟世界栩栩如生。

#### ✨ 功能特性

- **纪元系统 (Era System)**：集成了由种群规模驱动的状态机，叙述世界演进纪元（创世、扩张、黄金时代、衰落等）。
- **名人堂 (Hall of Fame)**：实时排行榜，追踪模拟中适应度最高的前 3 名生物。
- **可视化叙事**：状态感知符号（†♥♦●）和基于生理状态的动态颜色映射。
- **高级分析**：滚动脑熵（香农熵）和平均寿命指标，用于监控生物多样性。
- **种群动态**：双火花线系统，实时可视化种群健康状况与硬件压力对比。

---

## [阶段 8: 顶级掠食者与基因协同 (Apex Predators & Genetic Synergy)] - 2026-01-20

### 演进飞跃：捕食、有性繁殖与数据可移植性

此阶段通过引入捕食者-猎物动态和基因交换机制，提升了模拟的复杂性。

#### ✨ 功能特性

- **进化捕食**：新增第 4 个神经输出"攻击性"，使生物能够捕食其他生物并获得巨大能量收益（80% 转化率）。
- **有性繁殖**：实现基因交叉，允许生物与附近配偶结合神经特征。
- **HexDNA 协议**：稳健的序列化格式，支持通过文本文件导出（`C` 键）和注入（`V` 键）生物。
- **高级感知**：重构感知系统，在多轮世界更新中避免借用检查器冲突。
- **增强编年史**：UI 事件日志现可叙述捕食事件和基因风暴。

---

## [阶段 7: 神圣交互 (Divine Interface)] - 2026-01-20

### 演进飞跃：交互与分类学

此阶段的重点是从被动观察者转变为主动的“数字神明”，引入了干预工具和复杂的物种分类系统。

#### ✨ 功能特性

- **鼠标驱动交互**：启用了完整的终端鼠标支持。用户现在可以点击单个生物来检查其神经状态、血统和特定的遗传特征。
- **程序化命名 engine**：每个生物现在都会根据其基因型分配一个唯一的、程序化生成的名称（例如 *Xylos-Tetra*, *Aether-7*），不再使用原始 UUID，以增强叙事感。
- **实时 UI 编年史**：实现了实时事件日志（“编年史”），叙述重大的演进事件（例如“第 5000 刻的大饥荒”，“传奇英雄 *Zenith* 已陨落”）。
- **神圣干预工具**：
    - **基因浪潮 (Genetic Surge)**：手动触发高变异爆发，强制种群快速适应。
    - **资源投放 (Food Injection)**：交互式放置资源簇，引导种群迁移。
- **基于基因型的物种聚类**：实现了 L2 范数距离算法，根据神经权重相似性将生物分组为“物种”，允许 UI 实时监控生物多样性及不同谱系的兴衰。

#### 🛠️ 技术成就

- **事件驱动的 UI 更新**：优化了事件循环，每帧排空事件队列，确保鼠标交互零延迟。
- **空间哈希查询**：集成了基于网格的空间分区系统，支持实时鼠标拾取并将感官查询复杂度优化至 $O(N \log N)$。

---

## [阶段 6: 沉浸 (Immersion)] - 2026-01-15

### 优化与部署阶段

专注于性能、灵活性和“屏幕保护程序”式的体验。

#### ✨ 功能特性

- **空间哈希优化 (Spatial Hash)**：使用动态空间哈希网格取代了 $O(N^2)$ 的邻居检查，支持在标准硬件上流畅运行 500+ 实体。
- **多模式支持**：
    - **标准模式**：具有完整仪表板的 TUI 界面。
    - **画境模式 (Screensaver)**：极简、无干扰的世界视图。
    - **静默模式 (Headless)**：用于数据挖掘和长期演进研究的高速后台模拟。
- **配置系统**：将所有模拟常量外部化到 `config.toml`，支持热调参。

---

## [阶段 5 & 5.5: 账本与区块链 (The Ledger & Blockchain)]

### 永恒历史与独立分析

确保每一个传奇的生命都被刻在数字穹顶之上。

#### ✨ 功能特性

- **JSONL 事件日志**：将每一次出生、死亡和环境变迁稳健地流式传输到 `logs/live.jsonl`。
- **传奇判定标准**：自动归档满足精英适应度阈值的“传奇生物”。
- **OpenTimestamps 锚定**：会话日志的 SHA-256 哈希被锚定到比特币区块链。
- **独立工具集**：
    - `primordium-ledger-analyzer`：生成详细报告及家谱可视化。
    - `primordium-ledger-verifier`：验证本地日志的完整性。

---

## [阶段 4: 神经觉醒 (Neural Awakening)]

### 向智能的过渡

用感官驱动的神经处理取代随机运动。

#### ✨ 功能特性

- **4x6x3 神经网络**：为每个生物实现多层感知器 (MLP)。
- **感官输入**：食物向量、能量储备、局部拥挤度。
- **实时大脑热图**：实时可视化当前选中生物的突触权重。

---

## [阶段 1-3: 原初与共振 (Genesis & Resonance)]

### 基础与硬件耦合

宇宙的诞生以及代码与硅片的耦合。

#### ✨ 功能特性

- **Ratatui 基础**：建立了高性能的 TUI 框架。
- **代谢能量循环**：复杂的生存系统，动作即能量。
- **硬件耦合气候**：将 CPU/RAM 负载转化为环境压力。
