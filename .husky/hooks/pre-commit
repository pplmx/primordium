#!/bin/sh
# husky-rs pre-commit hook

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# é¢œè‰²å’Œå›¾æ ‡å®šä¹‰
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

print_header() {
    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${CYAN}  ğŸ” $1${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

print_step() { echo "${BLUE}â†’${NC} $1"; }
print_success() { echo "  ${GREEN}âœ“${NC} $1"; }
print_error() { echo "  ${RED}âœ—${NC} $1"; }
print_warning() { echo "  ${YELLOW}âš ${NC} $1"; }
print_info() { echo "  ${CYAN}â„¹${NC}  $1"; }

run_check() {
    step_name="$1"
    command="$2"
    error_msg="$3"
    hint="$4"

    print_step "$step_name"

    # æ‰§è¡Œå‘½ä»¤å¹¶æ•è·è¾“å‡º
    if eval "$command" > /tmp/hook_output 2>&1; then
        print_success "Passed"
        rm -f /tmp/hook_output
        return 0
    else
        echo ""
        print_error "$error_msg"

        if [ -n "$hint" ]; then
            print_info "Fix: ${YELLOW}$hint${NC}"
        fi

        # æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…ï¼ˆé™åˆ¶è¡Œæ•°ï¼‰
        if [ -s /tmp/hook_output ]; then
            echo ""
            print_warning "Error details:"
            echo "${MAGENTA}$(head -15 /tmp/hook_output)${NC}"

            # å¦‚æœè¾“å‡ºå¤ªé•¿ï¼Œæç¤ºç”¨æˆ·
            if [ "$(wc -l < /tmp/hook_output)" -gt 15 ]; then
                echo ""
                print_info "... (output truncated, run the fix command to see full details)"
            fi
        fi

        echo ""
        rm -f /tmp/hook_output
        return 1
    fi
}

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ä¸»é€»è¾‘
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print_header "Pre-Commit Checks"

# è®°å½•å¼€å§‹æ—¶é—´
START_TIME=$(date +%s)

# æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„æ–‡ä»¶
if git diff --cached --quiet; then
    print_warning "No staged changes to commit"
    exit 0
fi

# 1. æ ¼å¼æ£€æŸ¥
run_check \
    "ğŸ”§ Checking code formatting..." \
    "cargo fmt --all -- --check" \
    "Code is not formatted" \
    "cargo fmt --all" \
|| exit 1

echo ""

# 2. Clippy æ£€æŸ¥
run_check \
    "ğŸ” Running Clippy linter..." \
    "cargo clippy --workspace --all-targets --all-features -- -D warnings" \
    "Clippy found issues" \
    "cargo clippy --fix --workspace --all-targets --all-features --allow-dirty --allow-staged" \
|| exit 1

echo ""

# 3. ç¼–è¯‘æ£€æŸ¥
run_check \
    "ğŸ“¦ Checking compilation..." \
    "cargo check --workspace --all-targets --all-features" \
    "Compilation failed" \
    "cargo fix --workspace --all-targets --all-features --allow-dirty --allow-staged" \
|| exit 1

echo ""

# 4. å•å…ƒæµ‹è¯•
print_step "ğŸ§ª Running unit tests..."
if cargo test --lib --workspace --quiet 2>&1 | tee /tmp/test_output > /dev/null; then
    print_success "All unit tests passed"

    # æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡
    if grep -q "test result:" /tmp/test_output; then
        TEST_SUMMARY=$(grep "test result:" /tmp/test_output | head -1)
        print_info "$TEST_SUMMARY"
    fi
else
    echo ""
    print_error "Unit tests failed"
    print_info "Fix: Review and fix the failing tests"
    echo ""
    print_warning "Failed tests:"
    echo "${RED}$(grep -E "FAILED|failures:" /tmp/test_output)${NC}"
    echo ""
    print_info "Run ${YELLOW}cargo test --lib --workspace${NC} for full output"
    rm -f /tmp/test_output
    exit 1
fi

rm -f /tmp/test_output

echo ""

# 5. Cargo.lock åŒæ­¥æ£€æŸ¥
if [ -f Cargo.lock ]; then
    run_check \
        "ğŸ” Verifying Cargo.lock is up-to-date..." \
        "cargo metadata --format-version 1 > /dev/null 2>&1" \
        "Cargo.lock is out of sync" \
        "cargo update" \
    || exit 1
fi

# è®¡ç®—è€—æ—¶
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo ""
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}  âœ“ All pre-commit checks passed!${NC}"
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
print_info "Completed in ${CYAN}${ELAPSED}s${NC}"
echo ""
