#!/bin/sh
# husky-rs commit-msg hook

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# é¢œè‰²å’Œå›¾æ ‡å®šä¹‰
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
# BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_header() {
    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${CYAN}  ğŸ“ $1${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

print_success() { echo "${GREEN}âœ“${NC} $1"; }
print_error() { echo "${RED}âœ—${NC} $1"; }
print_warning() { echo "${YELLOW}âš ${NC} $1"; }
print_info() { echo "${CYAN}â„¹${NC}  $1"; }

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ä¸»é€»è¾‘
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
first_line=$(echo "$commit_msg" | head -n 1)

print_header "Commit Message Validation"

# 1. æ£€æŸ¥æ˜¯å¦ä¸ºç©º
if [ -z "$first_line" ]; then
    print_error "Commit message is empty"
    exit 1
fi

# 2. æ£€æŸ¥æœ€å°é•¿åº¦
MIN_LENGTH=10
if [ ${#first_line} -lt $MIN_LENGTH ]; then
    echo ""
    print_error "Commit subject too short (${#first_line} chars, minimum $MIN_LENGTH)"
    print_info "Current: ${YELLOW}$first_line${NC}"
    echo ""
    exit 1
fi

# 3. æ£€æŸ¥æœ€å¤§é•¿åº¦ï¼ˆè­¦å‘Šï¼‰
MAX_LENGTH=72
if [ ${#first_line} -gt $MAX_LENGTH ]; then
    echo ""
    print_warning "Commit subject exceeds $MAX_LENGTH characters (${#first_line} chars)"
    print_info "Consider shortening for better readability"
fi

# 4. Conventional Commits æ ¼å¼æ£€æŸ¥
CONVENTIONAL_REGEX="^(feat|fix|docs|style|refactor|test|chore|ci|perf|revert|build)(\(.+\))?: .+"

if ! echo "$first_line" | grep -qE "$CONVENTIONAL_REGEX"; then
    echo ""
    print_error "Commit message must follow Conventional Commits format"
    echo ""
    print_info "Format: ${CYAN}<type>${NC}${YELLOW}(scope)${NC}: ${GREEN}<subject>${NC}"
    echo ""
    echo "  ${CYAN}Available Types:${NC}"
    echo "    ${YELLOW}feat${NC}     â”‚ New feature"
    echo "    ${YELLOW}fix${NC}      â”‚ Bug fix"
    echo "    ${YELLOW}docs${NC}     â”‚ Documentation changes"
    echo "    ${YELLOW}style${NC}    â”‚ Code style (formatting, missing semicolons, etc.)"
    echo "    ${YELLOW}refactor${NC} â”‚ Code refactoring"
    echo "    ${YELLOW}test${NC}     â”‚ Adding or updating tests"
    echo "    ${YELLOW}chore${NC}    â”‚ Maintenance tasks"
    echo "    ${YELLOW}perf${NC}     â”‚ Performance improvements"
    echo "    ${YELLOW}ci${NC}       â”‚ CI/CD configuration changes"
    echo "    ${YELLOW}build${NC}    â”‚ Build system or dependencies"
    echo "    ${YELLOW}revert${NC}   â”‚ Revert previous commit"
    echo ""
    echo "  ${CYAN}Examples:${NC}"
    echo "    ${GREEN}feat(auth): add OAuth2 login support${NC}"
    echo "    ${GREEN}fix: resolve memory leak in event loop${NC}"
    echo "    ${GREEN}docs(readme): update installation guide${NC}"
    echo "    ${GREEN}test(api): add integration tests for users endpoint${NC}"
    echo ""
    print_info "Your message: ${RED}$first_line${NC}"
    echo ""
    exit 1
fi

# 5. æ£€æŸ¥ä¸»é¢˜æ ¼å¼ï¼ˆå¯é€‰è§„åˆ™ï¼‰
subject=$(echo "$first_line" | sed -E 's/^[a-z]+(\([^)]+\))?: //')

# æ£€æŸ¥æ˜¯å¦ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼ˆå»ºè®®å°å†™ï¼‰
first_char=$(echo "$subject" | cut -c1)
if echo "$first_char" | grep -q '[A-Z]'; then
    echo ""
    print_warning "Subject should start with lowercase letter"
    print_info "Current:   ${YELLOW}$subject${NC}"
    print_info "Suggested: ${GREEN}$(echo "$subject" | sed 's/^./\L&/')${NC}"
fi

# æ£€æŸ¥æ˜¯å¦ä»¥å¥å·ç»“å°¾
if echo "$first_line" | grep -q '\.$'; then
    echo ""
    print_warning "Subject should not end with a period"
fi

# æˆåŠŸ
echo ""
print_success "${GREEN}Commit message is valid!${NC}"
echo ""
