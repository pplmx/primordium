#!/bin/sh
# husky-rs pre-push hook

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# é¢œè‰²å’Œå›¾æ ‡å®šä¹‰
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

print_header() {
    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${CYAN}  ğŸš€ $1${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

print_step() { echo "${BLUE}â†’${NC} $1"; }
print_success() { echo "  ${GREEN}âœ“${NC} $1"; }
print_error() { echo "  ${RED}âœ—${NC} $1"; }
print_warning() { echo "  ${YELLOW}âš ${NC} $1"; }
print_info() { echo "  ${CYAN}â„¹${NC}  $1"; }

run_check() {
    step_name="$1"
    command="$2"
    error_msg="$3"
    hint="$4"

    print_step "$step_name"

    if eval "$command" > /tmp/hook_output 2>&1; then
        print_success "Passed"
        rm -f /tmp/hook_output
        return 0
    else
        echo ""
        print_error "$error_msg"

        if [ -n "$hint" ]; then
            print_info "Fix: ${YELLOW}$hint${NC}"
        fi

        if [ -s /tmp/hook_output ]; then
            echo ""
            print_warning "Error details:"
            echo "${MAGENTA}$(head -20 /tmp/hook_output)${NC}"
        fi

        echo ""
        rm -f /tmp/hook_output
        return 1
    fi
}

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ä¸»é€»è¾‘
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print_header "Pre-Push Verification"

# è·å–å½“å‰åˆ†æ”¯
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
print_info "Branch: ${CYAN}$BRANCH${NC}"
echo ""

# è®°å½•å¼€å§‹æ—¶é—´
START_TIME=$(date +%s)

# 1. å®Œæ•´æµ‹è¯•å¥—ä»¶
print_step "ğŸ§ª Running complete test suite..."
print_warning "   This may take a moment..."
echo ""

if cargo test --workspace --all-features 2>&1 | tee /tmp/test_output; then
    echo ""
    print_success "All tests passed"

    # æå–æµ‹è¯•ç»Ÿè®¡
    if grep -q "test result:" /tmp/test_output; then
        echo ""
        print_info "Test Summary:"
        grep "test result:" /tmp/test_output | while read -r line; do
            echo "     $line"
        done
    fi
else
    echo ""
    print_error "Tests failed"
    print_info "Review the test output above to identify failures"
    echo ""
    print_info "Run ${YELLOW}cargo test --workspace --all-features${NC} to debug"
    rm -f /tmp/test_output
    exit 1
fi

rm -f /tmp/test_output

echo ""

# 2. Release æ„å»ºæ£€æŸ¥
run_check \
    "ğŸ“¦ Verifying release build..." \
    "cargo build --release --workspace --all-features --quiet" \
    "Release build failed" \
    "Check the build errors and fix them" \
|| exit 1

echo ""

# 3. æ–‡æ¡£æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
print_step "ğŸ“š Checking documentation..."
if cargo doc --workspace --all-features --no-deps --quiet 2>&1 | tee /tmp/doc_output > /dev/null; then
    print_success "Documentation built successfully"
else
    print_warning "Documentation check failed (non-blocking)"

    # æ˜¾ç¤ºè­¦å‘Šä½†ä¸é˜»æ­¢ push
    if [ -s /tmp/doc_output ]; then
        echo ""
        print_info "Documentation warnings/errors:"
        echo "${YELLOW}$(head -10 /tmp/doc_output)${NC}"
    fi

    print_info "Run ${YELLOW}cargo doc --workspace --all-features${NC} to see full output"
fi

rm -f /tmp/doc_output

echo ""

# 4. ä¾èµ–å®¡è®¡ï¼ˆå¯é€‰ï¼Œéœ€è¦å®‰è£… cargo-auditï¼‰
if command -v cargo-audit > /dev/null 2>&1; then
    print_step "ğŸ”’ Auditing dependencies for vulnerabilities..."

    if cargo audit 2>&1 | tee /tmp/audit_output > /dev/null; then
        print_success "No vulnerabilities found"
    else
        print_warning "Vulnerabilities detected (non-blocking)"

        if [ -s /tmp/audit_output ]; then
            echo ""
            print_info "Security advisory:"
            echo "${YELLOW}$(cat /tmp/audit_output)${NC}"
            echo ""
            print_info "Run ${YELLOW}cargo audit${NC} for details"
        fi
    fi

    rm -f /tmp/audit_output
    echo ""
else
    print_info "ğŸ’¡ Install ${YELLOW}cargo-audit${NC} for security checks:"
    print_info "   ${CYAN}cargo install cargo-audit${NC}"
    echo ""
fi

# è®¡ç®—è€—æ—¶
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}  âœ“ All checks passed! Ready to push ğŸš€${NC}"
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
print_info "Total time: ${CYAN}${ELAPSED}s${NC}"
echo ""
